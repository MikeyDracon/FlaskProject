<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sistema de Turnos</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1>üìä Dashboard Administrativo</h1>
                <p>Bienvenido, {{ admin_username }}</p>
            </div>
            <div>
                <a href="{{ url_for('logout') }}" class="btn btn-warning">üö™ Cerrar Sesi√≥n</a>
                <a href="{{ url_for('index') }}" class="btn btn-secondary">üåê Vista P√∫blica</a>
            </div>
        </header>

        <!-- Men√∫ de Navegaci√≥n -->
        <nav class="nav-menu" style="background: white; padding: 1rem; border-radius: var(--border-radius); margin-bottom: 2rem;">
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <a href="#estadisticas" class="btn btn-primary">üìà Estad√≠sticas</a>
                <a href="#turnos" class="btn btn-primary">üìã Gesti√≥n de Turnos</a>
                <a href="#busqueda" class="btn btn-primary">üîç B√∫squeda</a>
                <a href="#catalogos" class="btn btn-primary">üìö Cat√°logos</a>
            </div>
        </nav>

        <!-- Estad√≠sticas -->
        <section id="estadisticas" class="dashboard-section">
            <h2>üìà Estad√≠sticas de Turnos</h2>
            <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div class="stat-card" style="background: white; padding: 1.5rem; border-radius: var(--border-radius); text-align: center;">
                    <h3>Total Turnos</h3>
                    <div class="stat-number" style="font-size: 2rem; font-weight: bold; color: var(--secondary-color);">{{ stats.total_turnos }}</div>
                </div>
                <div class="stat-card" style="background: white; padding: 1.5rem; border-radius: var(--border-radius); text-align: center;">
                    <h3>Pendientes</h3>
                    <div class="stat-number" style="font-size: 2rem; font-weight: bold; color: var(--warning-color);">{{ stats.pendientes }}</div>
                </div>
                <div class="stat-card" style="background: white; padding: 1.5rem; border-radius: var(--border-radius); text-align: center;">
                    <h3>Resueltos</h3>
                    <div class="stat-number" style="font-size: 2rem; font-weight: bold; color: var(--success-color);">{{ stats.resueltos }}</div>
                </div>
                <div class="stat-card" style="background: white; padding: 1.5rem; border-radius: var(--border-radius); text-align: center;">
                    <h3>Por Municipio</h3>
                    <div class="stat-number" style="font-size: 2rem; font-weight: bold; color: var(--primary-color);">{{ stats.total_municipios }}</div>
                </div>
            </div>

            <!-- Gr√°ficas -->
            <div class="charts-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div style="background: white; padding: 1.5rem; border-radius: var(--border-radius);">
                    <h4>Estatus de Turnos</h4>
                    <canvas id="estatusChart"></canvas>
                </div>
                <div style="background: white; padding: 1.5rem; border-radius: var(--border-radius);">
                    <h4>Turnos por Municipio</h4>
                    <canvas id="municipiosChart"></canvas>
                </div>
            </div>
        </section>

        <!-- Gesti√≥n de Turnos -->
        <section id="turnos" class="dashboard-section" style="margin-top: 3rem;">
            <h2>üìã Gesti√≥n de Turnos</h2>
            <div class="filters" style="background: white; padding: 1rem; border-radius: var(--border-radius); margin-bottom: 1rem;">
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <select id="filterEstado" class="form-control">
                        <option value="">Todos los estados</option>
                        <option value="pendiente">Pendiente</option>
                        <option value="atendido">Atendido</option>
                        <option value="resuelto">Resuelto</option>
                        <option value="cancelado">Cancelado</option>
                    </select>
                    <select id="filterMunicipio" class="form-control">
                        <option value="">Todos los municipios</option>
                        {% for municipio in municipios %}
                        <option value="{{ municipio }}">{{ municipio }}</option>
                        {% endfor %}
                    </select>
                    <button id="btnFiltrar" class="btn btn-primary">Filtrar</button>
                </div>
            </div>

            <div id="turnosList" class="turnos-list">
                <!-- Los turnos se cargar√°n aqu√≠ via JavaScript -->
            </div>
        </section>

    <section id="gestion-codigos" class="dashboard-section" style="margin-top: 3rem;">
    <h2>üîë Gesti√≥n de C√≥digos de Registro</h2>
    <div style="background: white; padding: 1.5rem; border-radius: var(--border-radius);">
        <div class="form-row">
            <div class="form-group">
                <button id="btnGenerarCodigo" class="btn btn-success">
                    üé´ Generar C√≥digo de Registro
                </button>
            </div>
            <div class="form-group">
                <button id="btnVerCodigos" class="btn btn-info">
                    üìã Ver C√≥digos Activos
                </button>
            </div>
        </div>

        <div id="codigosResult" style="margin-top: 1rem;"></div>
    </div>
</section>

        <!-- B√∫squeda -->
        <section id="busqueda" class="dashboard-section" style="margin-top: 3rem;">
            <h2>üîç B√∫squeda Avanzada</h2>
            <div class="search-forms" style="background: white; padding: 1.5rem; border-radius: var(--border-radius);">
                <div class="form-row">
                    <div class="form-group">
                        <label for="searchCURP">Buscar por CURP</label>
                        <input type="text" id="searchCURP" class="form-control" placeholder="Ingresa la CURP">
                    </div>
                    <div class="form-group">
                        <label for="searchNombre">Buscar por Nombre</label>
                        <input type="text" id="searchNombre" class="form-control" placeholder="Ingresa el nombre">
                    </div>
                </div>
                <button id="btnBuscar" class="btn btn-primary">Buscar</button>

                <div id="searchResults" style="margin-top: 1rem;">
                    <!-- Resultados de b√∫squeda -->
                </div>
            </div>
        </section>
    </div>

    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
</body>
</html>

// Gesti√≥n de c√≥digos de registro
document.getElementById('btnGenerarCodigo').addEventListener('click', generarCodigoRegistro);
document.getElementById('btnVerCodigos').addEventListener('click', verCodigosActivos);

async function generarCodigoRegistro() {
    try {
        const response = await fetch('/admin/generate-code');
        const result = await response.json();

        if (result.success) {
            document.getElementById('codigosResult').innerHTML = `
                <div class="success-message">
                    <strong>‚úÖ ${result.message}</strong><br>
                    <code style="font-size: 1.2rem; background: #f8f9fa; padding: 10px; display: block; margin: 10px 0;">
                        ${result.code}
                    </code>
                    <p>Comparte este c√≥digo con quien necesite registrarse. V√°lido por 24 horas.</p>
                </div>
            `;
        } else {
            document.getElementById('codigosResult').innerHTML = `
                <div class="error-message">‚ùå Error: ${result.error}</div>
            `;
        }
    } catch (error) {
        document.getElementById('codigosResult').innerHTML = `
            <div class="error-message">‚ùå Error de conexi√≥n</div>
        `;
    }
}

async function verCodigosActivos() {
    try {
        const response = await fetch('/admin/active-codes');
        const result = await response.json();

        if (result.success) {
            if (result.active_codes === 0) {
                document.getElementById('codigosResult').innerHTML = `
                    <div class="info-message">No hay c√≥digos activos</div>
                `;
            } else {
                let html = `<div class="success-message"><strong>üìã C√≥digos Activos: ${result.active_codes}</strong><br>`;

                for (const [code, data] of Object.entries(result.codes)) {
                    const expires = new Date(data.expires_at).toLocaleString();
                    html += `
                        <div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                            <strong>C√≥digo:</strong> <code>${code}</code><br>
                            <strong>Expira:</strong> ${expires}<br>
                            <strong>Usos restantes:</strong> ${data.max_uses}
                        </div>
                    `;
                }

                html += `</div>`;
                document.getElementById('codigosResult').innerHTML = html;
            }
        } else {
            document.getElementById('codigosResult').innerHTML = `
                <div class="error-message">‚ùå Error: ${result.error}</div>
            `;
        }
    } catch (error) {
        document.getElementById('codigosResult').innerHTML = `
            <div class="error-message">‚ùå Error de conexi√≥n</div>
        `;
    }
}